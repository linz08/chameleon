<!DOCTYPE html>
<!--suppress ALL -->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}" lang="ko">
<head>
    <title>문제편집</title>
    <link href="https://releases.jquery.com/git/ui/jquery-ui-git.css" />
</head>
<body>
<div layout:fragment="content" class="content">
    <div id="loader">
        <div
                class="spinner-border text-info position-absolute top-50 start-50"
                role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <form th:action="@{/quiz/update}" th:object="${quizModel}"
          id="updateForm" method="POST">
        <input type="hidden" th:value="${quizModel.quiz_number}"
               id="quiz_number" name="quiz_number"/>
        <div class="row">
            <div class="col">
                <span class="input-group-text" id="basic-addon1">출처</span> <select
                    class="form-select" aria-label="출처" th:name="quiz_source">
                <option th:each="src:${srcCodeList}" th:value="${src.code_id}"
                        th:selected="${src.code_id == quizModel.quiz_source}"
                        th:utext="${src.code_name}"></option>
            </select>
            </div>
            <div class="col">
                <span class="input-group-text" id="inputGroup-sizing-default">기존번호</span>
                <input type="text" name="quiz_org_number" id="quiz_org_number"
                       class="form-control" aria-label="Sizing example input"
                       th:value="${quizModel.quiz_org_number}"
                       aria-describedby="inputGroup-sizing-default">
            </div>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon2">문서분류</span> <select
                class="form-select" aria-label="분류" id="doc_code" th:name="doc_code">
            <option th:each="val:${docCatehogryList}"
                    th:value="${val.doc_code}"
                    th:selected="${val.doc_code==quizModel.doc_code}"
                    th:utext="${val.category_name}"></option>
        </select>
        </div>
        <div class="mb-3">
				<textarea name="quiz_title" id="quiz_title"
                          th:text="${quizModel.quiz_title}" class="ck_editor_txt"></textarea>
        </div>
        <div class="mb-3">
				<textarea name="quiz_subtitle" id="quiz_subtitle"
                          th:value="${quizModel.quiz_subtitle}"
                          th:text="${quizModel.quiz_subtitle}" class="ck_editor_txt"></textarea>
        </div>
        <div class="row">
            <div class="col">
                <span class="input-group-text" id="basic-addon3">문항방식</span> <select
                    class="form-select" th:field="*{quiz_code}" aria-label="문항방식">
                <option th:each="qc:${quizCodeList}" th:value="${qc.code_id}"
                        th:selected="${qc.code_id == quizModel.quiz_code}"
                        th:text="${qc.code_name}"></option>
            </select>
            </div>
            <div class="col">
                <span class="input-group-text" id="basic-addon4">문제패턴</span> <select
                    class="form-select" aria-label="문제패턴" th:field="*{pattern_code}">
                <option th:each="ptn:${ptnCodeList}" th:value="${ptn.code_id}"
                        th:selected="${ptn.code_id == quizModel.pattern_code}"
                        th:text="${ptn.code_name}"></option>
            </select>
            </div>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon5">난이도&nbsp;&nbsp;&nbsp;</span>
            <select class="form-select" aria-label="문제난이도"
                    th:field="*{quiz_level}">
                <option th:each="lvl:${lvlCodeList}" th:value="${lvl.code_id}"
                        th:selected="${lvl.code_id == quizModel.quiz_level}"
                        th:text="${lvl.code_name}"></option>
            </select>
        </div>
        <div class="textgroup">

            <th:block th:each="quizObjective:${quizObjectiveList}">
                <div class="input-group mb-3">
						<span th:text="${quizObjective.quiz_object_num}"
                              class="input-group-text" id="basic-addon6"></span>
                    <textarea name="quiz_object_name" id="quiz_object_name"
                              class="ck_editor_txt"
                              th:value="${quizObjective.quiz_object_name}"
                              th:text="${quizObjective.quiz_object_name}"></textarea>
                </div>
            </th:block>

        </div>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon7">문제해설</span>
            <textarea name="quiz_desc" id="quiz_desc" class="ck_editor_txt"
                      th:value="${quizModel.quiz_desc}"
                      th:text="${quizModel.quiz_desc}"></textarea>
        </div>
        <div class="row">
            <div class="col">
                <span class="input-group-text" id="basic-addon8">문제정답</span> <input type="text" name="quiz_answer"
                                                                                    id="quiz_answer"
                                                                                    class="form-control"
                                                                                    th:value="${quizModel.quiz_answer}">
            </div>
            <div class="col">
                <span class="input-group-text" id="basic-addon9">관련문서</span>
                <table class="doc_table" id="doc_table">
                    <tbody>
                    <tr>
                        <th scope="row"></th>
                        <td><input type="text" id="doc_name" class="form-control"></td>
                        <td><button type="button" class="btn btn-primary btn-sm" id="btn_doc_add">추가</button></td>
                    </tr>
                    <th:block th:each="quizDocumentModelList,index : ${quizDocumentModelList}">
                        <tr>
                            <th th:text="${index.index+1}" scope="row">번호</th>
                            <td th:text="${quizDocumentModelList.doc_name}">문서명
                            </td>
                            <td>
                                <button type="button" class="btn btn-secondary btn-sm" id="btn_doc_del"
                                        th:myName="${quizDocumentModelList.doc_name}"
                                        th:onclick="doc_del(this.getAttribute('myName'))">삭제</button>
                            </td>
                        </tr>
                    </th:block>
                    </tbody>
                </table>
            </div>
        </div>
        <br/><br/>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button class="btn btn-primary me-md-2" type="button"
                    onclick="update();">수정완료
            </button>
            <a class="btn btn-primary" href="/index" role="button">취소하기</a>
        </div>

    </form>
    <!-- jQuery (부트스트랩의 자바스크립트 플러그인을 위해 필요합니다) -->
    <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script
    src="https://releases.jquery.com/git/ui/jquery-ui-git.js"></script>
    <!-- 모든 컴파일된 플러그인을 포함합니다 (아래), 원하지 않는다면 필요한 각각의 파일을 포함하세요 -->
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
            crossorigin="anonymous"></script>
    <script src="/js/ckeditor5-31/quiz/ckeditor.js"></script>
    <script>
        $(window).on('load', function () {
            $('#loader').hide();
        });
        let allEditors = document.querySelectorAll('.ck_editor_txt');
        for (let i = 0; i < allEditors.length; ++i) {
            ClassicEditor.create((allEditors[i]),
                {
                    simpleUpload:
                        {
                            uploadUrl: "/attach/image",
                            withCredentials: true,
                        },
                    autoParagraph: false
                })
                .then(newEditor => {
                    editr = newEditor;
                })
                .catch(error => {
                    console.log(error);
                });
        }

        $('#doc_name').autocomplete({
            source : function(request, response) { //source: 입력시 보일 목록
                $.ajax({
                    url : "/docSearch"
                    , type : "POST"
                    , dataType: "JSON"
                    , data : {doc_name: $("#doc_name").val()}	// 검색 키워드
                    ,beforeSend: function (jqXHR, settings) {
                        let header = $("meta[name='_csrf_header']").attr("content");
                        let token = $("meta[name='_csrf']").attr("content");
                        jqXHR.setRequestHeader(header, token);
                    }
                }).done(function (rData, textStatus, jqXHR) {
                    response(
                        $.map(rData.resultList, function(item) {
                            return {
                                label : item.doc_name    	// 목록에 표시되는 값
                                , value : item.doc_name 		// 선택 시 input창에 표시되는 값
                                //, idx : item.SEQ // index
                            };
                        })
                    );
                }).fail(function (rData, textStatus, errorThrown) {
                    alert("오류가 발생했습니다.");
                }).always(function (rData, textStatus, jqXHR) {});
            }
            ,focus : function(evt, ui) { // 방향키로 자동완성단어 선택 가능하게 만들어줌
                return false;
            },
            minLength: 1,// 최소 글자수
            delay: 100	//autocomplete 딜레이 시간(ms),
            , select : function(evt, ui) {
                // 아이템 선택시 실행 ui.item 이 선택된 항목을 나타내는 객체, lavel/value/idx를 가짐
                console.log(ui.item.label);
                //console.log(ui.item.idx);
            }
        });

        function update() {
            document.getElementById("updateForm").submit();
        }
        function doc_del(doc_name) {
            $.ajax({
                type: "POST",
                url: "/docDel",
                beforeSend: function (jqXHR, settings) {
                    let header = $("meta[name='_csrf_header']").attr("content");
                    let token = $("meta[name='_csrf']").attr("content");
                    jqXHR.setRequestHeader(header, token);
                },
                data: { "doc_name" : doc_name,
                    "doc_code" : $('#doc_code').val(),
                    "quiz_number" : $('#quiz_number').val() },
                success: function() {
                }, error: function(){
                    alert('실패');
                }
            });
        }

        $('#btn_doc_add').click(function(){
          $.ajax({
             type: "POST",
             url: "/docAdd",
             beforeSend: function (jqXHR, settings) {
                let header = $("meta[name='_csrf_header']").attr("content");
                let token = $("meta[name='_csrf']").attr("content");
                jqXHR.setRequestHeader(header, token);
            },
             data: { "doc_name" : $('#doc_name').val(),
                    "doc_code" : $('#doc_code').val(),
                    "quiz_number" : $('#quiz_number').val() },
              success: function() {
                  doc_reload();
              }, error: function(){
                 alert('실패');
              }
          });
        });

        function doc_reload() {
            let doc_code = $('#doc_code').val();
            let quiz_number = $('#quiz_number').val();

            $.ajax({
                type: "POST",
                url: "/quiz/doc/list",
                beforeSend: function (jqXHR, settings) {
                    let header = $("meta[name='_csrf_header']").attr("content");
                    let token = $("meta[name='_csrf']").attr("content");
                    jqXHR.setRequestHeader(header, token);
                },
                data: { "doc_name" : $('#doc_name').val(),
                        "doc_code" : $('#doc_code').val(),
                        "quiz_number" : $('#quiz_number').val() },
                success: function(data) {

                        let results = data.quizDocumentModelList;
                        let str = '<TR>';
                        $.each(results , function(i){
                            str += '<th scope="row">3</th>';
                            str += '<td>' + results[i].doc_name + '</td>';
                            str += '<td><button type="button" class="btn btn-secondary btn-sm" onclick=doc_del("+ results[i].doc_name +")">삭제</button>';
                            str += '</td></tr>';
                        });
                       $("#doc_table").append(str);
                }, error : function(request,status,error) {
                    console.log("code:" + request.status + "\n");
                    console.log("message:" + request.responseText + "\n");
                    console.log("error:" + error);
                }
            });
        }
    </script>
</div>
</body>
</html>